#!/usr/bin/env python3
"""
修复 newspaper3k 库中 lxml.html.clean 导入问题的脚本
"""

import os
import sys
import shutil

def fix_newspaper_import():
    """修复 newspaper 库的导入问题"""
    
    print("开始修复 newspaper3k 库导入问题...")
    
    # 方法1：尝试直接修复 parsers.py 文件
    try:
        import site
        import newspaper
        
        # 找到 newspaper 包的路径
        newspaper_path = os.path.dirname(newspaper.__file__)
        parsers_path = os.path.join(newspaper_path, 'parsers.py')
        
        if os.path.exists(parsers_path):
            print(f"找到 parsers.py: {parsers_path}")
            
            # 备份原文件
            backup_path = parsers_path + '.bak'
            shutil.copy2(parsers_path, backup_path)
            print(f"已创建备份: {backup_path}")
            
            # 读取文件内容
            with open(parsers_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # 替换有问题的导入
            if 'import xml.html' in content:
                # 替换为修复后的导入
                new_content = content.replace(
                    'import xml.html',
                    '''# 修复 lxml.html.clean 导入问题
try:
    from lxml_html_clean import clean
    from lxml import html as lxml_html
    import lxml.html
except ImportError:
    from lxml.html.clean import clean
    from lxml import html as lxml_html
    import lxml.html'''
                )
                
                # 写回文件
                with open(parsers_path, 'w', encoding='utf-8') as f:
                    f.write(new_content)
                
                print("已修复 parsers.py 文件")
                return True
            else:
                print("未找到需要修复的导入语句")
    except Exception as e:
        print(f"修复 parsers.py 失败: {e}")
    
    # 方法2：创建猴子补丁
    print("应用猴子补丁...")
    patch_code = '''
import sys
import importlib

# 猴子补丁：创建假的 xml.html 模块
class FakeXmlHtmlModule:
    def __init__(self):
        self.clean = None
    
    def __getattr__(self, name):
        # 延迟导入真实的 lxml.html
        if name == 'clean':
            try:
                from lxml_html_clean import clean
                return clean
            except ImportError:
                from lxml.html.clean import clean
                return clean
        raise AttributeError(f"module 'xml.html' has no attribute '{name}'")

# 将假的模块插入 sys.modules
sys.modules['xml.html'] = FakeXmlHtmlModule()
'''
    
    # 在导入 newspaper 之前执行补丁
    exec(patch_code)
    print("猴子补丁已应用")
    
    return True

if __name__ == '__main__':
    success = fix_newspaper_import()
    sys.exit(0 if success else 1)
